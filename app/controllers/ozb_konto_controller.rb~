class OzbKontoController < ApplicationController

  def index
  
    @ozb_konten = OZBKonto.where( :mnr => params[:id] )
    @ee_konten = Array.new
    @ze_konten = Array.new
    
    @ee_count = 0
    @ze_count = 0
    @ozb_konten.each do |konto|
      if konto.EEKonto.count > 0 then
        @ee_konten.push(konto.EEKonto.first)
        @ee_count += 1
      end
      if konto.ZEKonto.count > 0 then
        @ze_konten.push(konto.ZEKonto.first)
        @ze_count += 1
      end
    end
    
  end
    
  def new
    searchKtoNr()
    @person = Person.where( :pnr => params[:id] ).first
    @ozb_konten = OZBKonto.where( :mnr => params[:id] )

    if params[:typ] == "EE" then      
      count = 0
      @ozb_konten.each do |konto|
        if konto.EEKonto.count > 0 then
          count += 1
        end
      end
     
      # Neue Kontonummer erzeugen
      @newKtoNr = (count + 5).to_s
      (1..(4-@person.pnr.to_s.length)).each do |i|
        @newKtoNr += "0"
      end
      @newKtoNr += @person.pnr.to_s
      
      render "new_ee.html.erb"
    end
    
    if params[:typ] == "ZE" then
      count = 0
      @ozb_konten.each do |konto|
        if konto.ZEKonto.count > 0 then
          count += 1
        end
      end
     
      # Neue Kontonummer erzeugen
      @newKtoNr = (count + 1).to_s
      (1..(4-@person.pnr.to_s.length)).each do |i|
        @newKtoNr += "0"
      end
      @newKtoNr += @person.pnr.to_s
    end
    
    render "new_ze.html.erb"
  
  end
  
  def save
  
    if params[:typ] == "EE" then
      # Editieren
      begin
        @ozb_konto = OZBKonto.where( :ktoNr => params[:ozbKtoNr] ).first
        @ee_konto = @ozb_konto.EEKonto.first
        @bankverbindung = Bankverbindung.where( :id => @ee_konto.bankId ).first
        
        @ee_konto.kreditlimit = params[:kreditlimit]
        @ee_konto.save
        
        @bankverbindung.bankKtoNr = params[:bankKtoNr]
        @bankverbindung.bankName = params[:bankName]
        @bankverbindung.blz = params[:blz]
        @bankverbindung.bic = params[:bic]
        @bankverbindung.iban = params[:iban]
        @bankverbindung.save
        
      rescue
        # Neu anlegen
        # OZB-Konto:  :ktoNr, :mnr, :ktoEinrDatum, :waehrung, :wSaldo, :pSaldo, :saldoDatum
        @ozb_konto = OZBKonto.create( :ktoNr => params[:ozbKtoNr], :mnr => params[:id], :ktoEinrDatum => params[:ktoEinrDatum],
                                      :waehrung => "EUR", :wSaldo => params[:wSaldo], :pSaldo => params[:pSaldo], :saldoDatum => params[:saldoDatum] )
        @ozb_konto.save
        
        # Bankverbindung: id, :pnr, :bankKtoNr, :blz, :bic, :iban, :bankName    
        @bankverbindung = Bankverbindung.create( :pnr => params[:id], :bankKtoNr => params[:bankKtoNr], :blz => params[:blz], :bic => params[:bic], 
                                                 :iban => params[:iban], :bankName => params[:bankName] )
        @bankverbindung.save
        
        # EE-Konto:  :ktoNr, :bankId, :kreditlimit
        @eeKonto = EEKonto.create( :ktoNr => params[:ozbKtoNr], :bankId => @bankverbindung.id, :kreditlimit => params[:kreditlimit] )
        @eeKonto.save
      end
      
      redirect_to :action => "index"
    end
    
    if params[:typ] == "ZE" then
    
      begin
        # Editieren
        @ozb_konto = OZBKonto.where( :ktoNr => params[:ozbKtoNr] ).first
        @ze_konto = ZEKonto.where( :ktoNr => params[:zeKtoNr] ).first
        @ze_konto.zeEndDatum = params[:zeEndDatum]
        @ze_konto.zahlModus = params[:zahlModus]
        @ze_konto.tilgRate = params[:tilgRate]
        @ze_konto.ansparRate = params[:ansparRate]
        @ze_konto.kduRate = params[:kduRate]
        @ze_konto.rduRate = params[:rduRate]
        @ze_konto.save
      rescue
        # Neu anlegen
        # OZB-Konto:  :ktoNr, :mnr, :ktoEinrDatum, :waehrung, :wSaldo, :pSaldo, :saldoDatum
        @ozb_konto = OZBKonto.create( :ktoNr => params[:ozbKtoNr], :mnr => params[:id], :ktoEinrDatum => params[:ktoEinrDatum],
                                      :waehrung => "EUR", :wSaldo => params[:wSaldo], :pSaldo => params[:pSaldo], :saldoDatum => params[:saldoDatum] )
        @ozb_konto.save
        
        #ZE-Konto:  :ktoNr, :eeKtoNr, :pgNr, :zeNr, :zeAbDatum, :zeEndDatum, :zeBetrag, :laufzeit, :zahlModus, :tilgRate, :ansparRate, :kduRate, :rduRate, :zeStatus
        @ze_konto = ZEKonto.create( :ktoNr => params[:ozbKtoNr], :eeKtoNr => params[:eeKtoNr], :pgNr => params[:id], :zeNr => params[:zeNr], 
                                    :zeAbDatum => Date.parse(params[:zeAbDatum]), :zeEndDatum => Date.parse(params[:zeEndDatum]), 
                                    :zeBetrag => params[:zeBetrag], :laufzeit => params[:laufzeit], :zahlModus => params[:zahlModus], 
                                    :tilgRate => params[:tilgRate], :ansparRate => params[:ansparRate], :kduRate => params[:kduRate], 
                                    :rduRate => params[:rduRate], :zeStatus => params[:zeStatus] )
        @ze_konto.save
      end
      
      redirect_to :action => "index"    
    end
  
  end
  
  def edit
    searchKtoNr()
    @ozb_konto = OZBKonto.where( :ktoNr => params[:ktoNr] ).first
    if params[:typ] == "EE" then
      @ee_konto = @ozb_konto.EEKonto.first
      @bankverbindung = Bankverbindung.where( :id => @ee_konto.bankId ).first
      
      render "edit_ee.html.erb"
    end
    
    if params[:typ] == "ZE" then
      @ze_konto = @ozb_konto.ZEKonto.first
      
      render "edit_ze.html.erb"
    end
  
  end
  
  def delete
    #begin
      @konto = OZBKonto.where( :ktoNr => params[:ktoNr] ).first
      puts @konto.inspect
      @konto.delete
      redirect_to :action => "index"
    #rescue
    #end
    
  end

  def searchKtoNr
    if( !params[:ktoNr].nil? ) then
      @konten = OZBKonto.all
    end
    super
  end

end
